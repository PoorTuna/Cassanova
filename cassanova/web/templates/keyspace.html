{% extends "base.html" %}

{% block title %}Keyspace: {{ keyspace.name }}{% endblock %}

{% block head_extra %}
<link href="/static/scripts/vendor/vis/vis-network.min.css" rel="stylesheet" />
<link href="/static/styles/app/main.css" rel="stylesheet">
<script>
    const clusterName = "{{ cluster_config_entry }}";
    const keyspaceName = "{{ keyspace.name }}";
    const schemaData = JSON.parse('{{ keyspace.model_dump() | tojson | safe }}');
</script>
<script src="/static/scripts/vendor/vis/vis-network.min.js" defer></script>
<script src="/static/scripts/app/table-actions.js" defer></script>
<script src="/static/scripts/app/schema-graph.js" defer></script>
{% endblock %}

{% block content %}
<main class="with-sidebar">
    <section class="keyspace-overview">
        <h2>Keyspace Overview</h2>
        <ul>
            <li class="copyable" title="Click to copy"><strong>Name:</strong> <span>{{ keyspace.name }}</span></li>
            <li class="copyable" title="Click to copy"><strong>Replication:</strong> <span>{{ keyspace.replication
                    }}</span></li>
            <li class="copyable" title="Click to copy"><strong>Durable Writes:</strong> <span>{{ keyspace.durable_writes
                    }}</span></li>
            <li class="copyable" title="Click to copy"><strong>Virtual:</strong> <span>{{ keyspace.virtual }}</span>
            </li>
            <li class="copyable" title="Click to copy"><strong>Table Count:</strong> <span>{{ keyspace.table_count
                    }}</span></li>
        </ul>
    </section>

    <section id="keyspace-tables-section" class="fade-in">
        <div class="section-header-row">
            <h2>Tables</h2>
            <div class="actions">
                <a href="/cluster/{{ cluster_config_entry }}/keyspace/{{ keyspace.name }}/builder"
                    class="btn-primary-sm">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"></path>
                    </svg>
                    Create New Table
                </a>
            </div>
        </div>
        <input type="search" id="table-filter" placeholder="Filter tables..." autocomplete="off"
            aria-label="Filter tables" />

        <div class="keyspaces-container">
            <!-- Sidebar List -->
            <div id="table-list">
                {% for table in keyspace.tables %}
                <div class="keyspace-item" data-name="{{ table.name }}">
                    <strong>{{ table.name }}</strong>
                    <div class="keyspace-meta">Columns: {{ table.columns | length }}</div>
                </div>
                {% else %}
                <p class="no-keyspaces">No tables available.</p>
                {% endfor %}
            </div>

            <!-- Detail Panel -->
            <div id="table-detail">
                <div class="empty-state">
                    <div class="icon-layer">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="9" y1="21" x2="9" y2="9"></line>
                        </svg>
                    </div>
                    <p>Select a table to view details</p>
                </div>

                {% for table in keyspace.tables %}
                <div class="table-detail hidden" id="table-{{ table.name }}">

                    <!-- Header -->
                    <header class="detail-header">
                        <div class="title-group">
                            <h3>{{ table.name }}</h3>
                            {% if table.virtual %}<span class="badge virtual">Virtual</span>{% endif %}
                            {% if table.is_compact_storage %}<span class="badge compact">Compact</span>{% endif %}
                        </div>
                        <div class="controls-group">
                            <div class="dropdown-wrapper">
                                <button class="table-options-btn" title="Actions" {% if table.virtual
                                    %}style="visibility: hidden; pointer-events: none;" {% endif %}>
                                    <svg width="20" height="20" viewBox="0 0 24 24">
                                        <circle cx="12" cy="5" r="2.5"></circle>
                                        <circle cx="12" cy="12" r="2.5"></circle>
                                        <circle cx="12" cy="19" r="2.5"></circle>
                                    </svg>
                                </button>
                                {% if not table.virtual %}
                                <div class="dropdown-menu hidden">
                                    <a href="/cluster/{{ cluster_config_entry }}/keyspace/{{ keyspace.name }}/table/{{ table.name }}/explore"
                                        class="btn-link">Browse Table</a>
                                    <button data-action="description" data-table="{{ table.name }}">Show
                                        Description</button>
                                    <button data-action="schema" data-table="{{ table.name }}">Show Schema</button>
                                    <button data-action="truncate" data-table="{{ table.name }}">Truncate Table</button>
                                    <button data-action="delete" data-table="{{ table.name }}" class="danger">Delete
                                        Table</button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </header>

                    <!-- Stats Grid -->
                    <div class="detail-grid">
                        <div class="detail-card">
                            <span class="label">Partition Key</span>
                            <span class="value code">{{ table.partition_key | join(', ') }}</span>
                        </div>
                        <div class="detail-card">
                            <span class="label">Clustering Key</span>
                            <span class="value code">
                                {% if table.clustering_key %}
                                {{ table.clustering_key | join(', ') }}
                                {% else %}
                                <span class="text-muted">None</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-card small">
                            <span class="label">Columns</span>
                            <span class="value accent">{{ table.columns | length }}</span>
                        </div>
                        <div class="detail-card small">
                            <span class="label">Indexes</span>
                            <span class="value">{{ table.indexes | length }}</span>
                        </div>
                    </div>

                    <!-- Columns Section -->
                    <div class="detail-section">
                        <h4>Columns Schema</h4>
                        <div class="table-frame">
                            <table class="glass-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Static</th>
                                        <th>Reversed</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for name, info in table.columns.items() %}
                                    <tr>
                                        <td class="col-name">{{ name }}</td>
                                        <td class="col-type">{{ info.cql_type }}</td>
                                        <td>
                                            {% if info.is_static %}
                                            <span class="status-dot on"></span>
                                            {% else %}
                                            <span class="status-dot off"></span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if info.is_reversed %}
                                            <span class="status-dot on" title="Reversed"></span>
                                            {% else %}
                                            <span class="status-dot off"></span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Additional Details (Collapsible/Tabs could be next, but stacking for now) -->
                    {% if table.options %}
                    <div class="detail-section">
                        <h4>Table Options</h4>
                        <div class="options-grid">
                            {% for opt, val in table.options.items() %}
                            <div class="option-item copyable" title="Click to copy">
                                <span class="opt-key">{{ opt }}</span>
                                <span class="opt-val">
                                    {% if val is mapping %}
                                    {{ val | tojson }}
                                    {% elif val == None %}
                                    N/A
                                    {% else %}
                                    {{ val }}
                                    {% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    {% if keyspace.indexes %}
    <section class="fade-in">
        <h2>Indexes</h2>
        <div class="detail-section">
            <div class="options-grid">
                {% for index in keyspace.indexes %}
                <div class="option-item copyable" title="Click to copy">
                    <span class="opt-key">{{ index.name if index is mapping else 'Index ' ~ loop.index }}</span>
                    <span class="opt-val">{{ index.kind_name if index is mapping else index }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    {% if keyspace.user_types %}
    <section class="fade-in">
        <h2>User Types</h2>
        <ul>
            {% for ut_name, ut_def in keyspace.user_types.items() %}
            <li><strong>{{ ut_name }}:</strong> {{ ut_def }}</li>
            {% endfor %}
        </ul>
    </section>
    {% endif %}

    {% if keyspace.functions %}
    <section class="fade-in">
        <h2>Functions</h2>
        <ul>
            {% for fn_name, fn_def in keyspace.functions.items() %}
            <li><strong>{{ fn_name }}:</strong> {{ fn_def }}</li>
            {% endfor %}
        </ul>
    </section>
    {% endif %}

    {% if keyspace.aggregates %}
    <section class="fade-in">
        <h2>Aggregates</h2>
        <ul>
            {% for agg_name, agg_def in keyspace.aggregates.items() %}
            <li><strong>{{ agg_name }}:</strong> {{ agg_def }}</li>
            {% endfor %}
        </ul>
    </section>
    {% endif %}

    {% if keyspace.views %}
    <section class="fade-in">
        <h2>Views</h2>
        <ul>
            {% for view_name, view_def in keyspace.views.items() %}
            <li><strong>{{ view_name }}:</strong> {{ view_def }}</li>
            {% endfor %}
        </ul>
    </section>
    {% endif %}

    {% if keyspace.graph_engine %}
    <section class="fade-in">
        <h2>Graph Engine</h2>
        <pre>{{ keyspace.graph_engine }}</pre>
    </section>
    {% endif %}

    <section class="fade-in">
        <h2>Schema Overview</h2>
        <div id="schema-graph" style="width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 8px;"></div>
    </section>

</main>

<div id="json-modal" class="modal hidden">
    <div class="modal-content">
        <span id="modal-close" class="modal-close">&times;</span>
        <pre id="modal-pre" style="white-space: pre-wrap; max-height: 70vh; overflow-y: auto;"></pre>
    </div>
</div>
{% endblock %}