{% extends "base.html" %}

{% block title %}User Management â€” {{ cluster_name }}{% endblock %}

{% block head_extra %}
<link href="/static/styles/app/users.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<main class="with-sidebar">
    <section class="page-header">
        <div class="header-content">
            <h2>User Management</h2>
            <p class="subtitle">Roles, permissions and access control overview</p>
        </div>
        <div class="header-actions">
            <button id="add-user-btn" class="btn-primary">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="20" y1="8" x2="20" y2="14"></line>
                    <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                Create Role
            </button>
        </div>
    </section>

    <section class="guard-overview-stats">
        <div class="stat-card">
            <div class="stat-label">TOTAL ROLES</div>
            <div class="stat-value" id="total-roles-count">--</div>
        </div>
        <div class="stat-card superuser">
            <div class="stat-label">SUPERUSERS</div>
            <div class="stat-value" id="superuser-count">--</div>
        </div>
    </section>

    <div id="users-grid" class="users-grid">
        <div class="loading-state">
            <div class="spinner"></div>
            Loading roles...
        </div>
    </div>
</main>

<!-- Create Role Modal -->
<div id="create-modal" class="modal hidden">
    <div class="modal-content glass-panel">
        <div class="modal-header">
            <h3>Create New Role</h3>
            <span class="modal-close" data-modal="create-modal">&times;</span>
        </div>
        <form id="create-form">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="new-role-name">Role Name</label>
                        <input type="text" id="new-role-name" name="username" required placeholder="e.g. app_user"
                            autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="new-role-pass">Password (Optional)</label>
                        <input type="password" id="new-role-pass" name="password"
                            placeholder="Leave empty if not enabled">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" name="superuser">
                            <span class="label-text">Superuser (Admin)</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" name="login" checked>
                            <span class="label-text">Can Login</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary close-modal" data-modal="create-modal">Cancel</button>
                <button type="submit" class="btn-primary" id="btn-create">Create Role</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Role Modal -->
<div id="edit-modal" class="modal hidden">
    <div class="modal-content glass-panel">
        <div class="modal-header">
            <h3>Edit Role: <span id="edit-role-name-display" class="accent"></span></h3>
            <span class="modal-close" data-modal="edit-modal">&times;</span>
        </div>
        <form id="edit-form">
            <input type="hidden" id="edit-role-name" name="username">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="edit-role-pass">New Password (Optional)</label>
                        <input type="password" id="edit-role-pass" name="password"
                            placeholder="Enter to change password">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="edit-superuser" name="superuser">
                            <span class="label-text">Superuser</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="edit-login" name="login">
                            <span class="label-text">Can Login</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary close-modal" data-modal="edit-modal">Cancel</button>
                <button type="submit" class="btn-primary" id="btn-edit">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Permissions Modal -->
<div id="perm-modal" class="modal hidden">
    <div class="modal-content glass-panel large-modal">
        <div class="modal-header">
            <div class="title-group">
                <h3>Access Overview: <span id="perm-role-name-display" class="accent"></span></h3>
                <p class="subtitle">Resource coverage and permission map</p>
            </div>
            <span class="modal-close" data-modal="perm-modal">&times;</span>
        </div>
        <div class="modal-tabs">
            <button class="modal-tab-btn active" data-perm-tab="visualizer">Access Map</button>
            <button class="modal-tab-btn" data-perm-tab="list">Grant List</button>
        </div>
        <div class="modal-body">
            <!-- Visualizer Tab -->
            <div id="perm-tab-visualizer" class="perm-tab-content active">
                <div id="security-visualizer-grid" class="security-visualizer-grid">
                    <!-- Dynamic visual categories -->
                    <div class="vis-category" id="vis-ks">
                        <div class="vis-cat-header">KEYSPACE LEVEL</div>
                        <div class="vis-nodes" id="vis-nodes-ks"></div>
                    </div>
                    <div class="vis-category" id="vis-tb">
                        <div class="vis-cat-header">TABLE LEVEL</div>
                        <div class="vis-nodes" id="vis-nodes-tb"></div>
                    </div>
                    <div class="vis-category" id="vis-auth">
                        <div class="vis-cat-header">IDENTITY & AUTH</div>
                        <div class="vis-nodes" id="vis-nodes-auth"></div>
                    </div>
                </div>
            </div>

            <!-- List Tab -->
            <div id="perm-tab-list" class="perm-tab-content">
                <div class="perm-table-header">
                    <span class="col-perm">PERMISSION</span>
                    <span class="col-res">RESOURCE</span>
                    <span class="col-action">ACTION</span>
                </div>
                <div class="perm-list" id="perm-list">
                    <div class="loading-state">Syncing security nodes...</div>
                </div>
            </div>

            <div class="add-perm-form-container">
                <h4>Grant New Permission</h4>
                <div class="add-perm-form">
                    <div class="form-group" style="flex: 0 0 150px;">
                        <select id="perm-type">
                            <option value="SELECT">SELECT</option>
                            <option value="MODIFY">MODIFY</option>
                            <option value="ALTER">ALTER</option>
                            <option value="DROP">DROP</option>
                            <option value="CREATE">CREATE</option>
                            <option value="AUTHORIZE">AUTHORIZE</option>
                            <option value="DESCRIBE">DESCRIBE</option>
                            <option value="EXECUTE">EXECUTE</option>
                            <option value="UNMASK">UNMASK</option>
                            <option value="SELECT_MASKED">SELECT_MASKED</option>
                            <option value="ALL">ALL</option>
                        </select>
                    </div>
                    <div class="form-group"
                        style="flex: 1; display:flex; flex-direction:row; align-items:center; gap:8px;">
                        <span style="color:var(--text-muted); font-size:0.9rem; margin-bottom:0;">ON</span>
                        <input type="text" id="perm-resource" placeholder="e.g. ALL KEYSPACES or keyspace.table"
                            style="padding: 0.75rem 1rem;">
                    </div>
                    <button class="btn-primary" id="grant-btn" style="padding: 0.75rem 1.5rem;">Grant</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const clusterName = "{{ cluster_config_entry }}";
    let currentPermRole = null;

    document.addEventListener('DOMContentLoaded', () => {
        fetchRoles();
        setupModals();
    });

    // --- Roles Grid ---
    function fetchRoles() {
        const grid = document.getElementById('users-grid');
        const rolesCountEl = document.getElementById('total-roles-count');
        const superCountEl = document.getElementById('superuser-count');

        fetch(`/api/v1/cluster/${clusterName}/auth/roles`)
            .then(res => res.json())
            .then(roles => {
                grid.innerHTML = '';
                if (roles.error || roles.detail) return Toast.error(roles.detail || 'Failed to load roles');

                // Update Stats
                rolesCountEl.textContent = roles.length;
                const superCount = roles.filter(r => r.is_superuser).length;
                superCountEl.textContent = superCount;

                if (roles.length === 0) return grid.innerHTML = '<div class="empty-state">No roles found in the security registry.</div>';

                roles.forEach(role => {
                    const card = document.createElement('div');
                    card.className = `user-card glass-panel ${role.is_superuser ? 'superuser-card' : ''}`;
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="avatar ${role.is_superuser ? 'superuser' : ''}">${role.role.charAt(0).toUpperCase()}</div>
                            <div class="role-info">
                                <h4>${role.role}</h4>
                                <span class="badge ${role.is_superuser ? 'admin' : 'user'}">${role.is_superuser ? 'PRIVILEGED ACCESS' : 'RESTRICTED ACCESS'}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="prop">
                                <span class="label">LOGIN PERMISSION</span>
                                <span class="value ${role.can_login ? 'yes' : 'no'}">${role.can_login ? 'ENABLED' : 'DISABLED'}</span>
                            </div>
                            <div class="prop">
                                <span class="label">ROLE ASSIGNMENT</span>
                                <span class="value code">${role.is_superuser ? 'SUPERUSER' : 'STANDARD_ROLE'}</span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn-secondary btn-sm" onclick='openEdit("${role.role}", ${role.is_superuser}, ${role.can_login})'>MODIFY</button>
                            <button class="btn-secondary btn-sm" onclick='openPerms("${role.role}")'>PERMISSIONS</button>
                            <button class="btn-icon delete" onclick='deleteRole("${role.role}")' title="Revoke Role">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            })
            .catch(e => Toast.error(e.message));
    }

    // --- CRUD Actions ---
    window.deleteRole = (role) => {
        ConfirmModal.show({
            title: 'Delete Role',
            body: `Are you sure you want to permanently delete the role <strong>${role}</strong>? All associated permissions will be lost.`,
            confirmText: 'Delete Role',
            confirmClass: 'btn-danger',
            onConfirm: () => {
                fetch(`/api/v1/cluster/${clusterName}/auth/roles/${role}`, { method: 'DELETE' })
                    .then(async res => {
                        if (res.ok) { Toast.success('Role Deleted'); fetchRoles(); }
                        else { const e = await res.json(); Toast.error(e.detail); }
                    });
            }
        });
    };

    // --- Modals Setup ---
    function setupModals() {
        // Modal toggling
        document.querySelectorAll('[data-modal]').forEach(btn => {
            btn.onclick = () => document.getElementById(btn.dataset.modal).classList.add('hidden');
        });
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) e.target.classList.add('hidden');
        };

        // Create
        document.getElementById('add-user-btn').onclick = () => {
            document.getElementById('create-modal').classList.remove('hidden');
            document.getElementById('new-role-name').focus();
        };

        // Tab Switching in Perm Modal
        document.querySelectorAll('[data-perm-tab]').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.permTab;
                document.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.perm-tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`perm-tab-${target}`).classList.add('active');
            });
        });

        document.getElementById('create-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-create');
            btn.textContent = 'PROVISIONING...'; btn.disabled = true;

            const data = Object.fromEntries(new FormData(e.target));
            data.superuser = !!data.superuser;
            data.login = !!data.login;

            try {
                const res = await fetch(`/api/v1/cluster/${clusterName}/auth/roles`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    Toast.success('Role Provisioned');
                    document.getElementById('create-modal').classList.add('hidden');
                    e.target.reset();
                    fetchRoles();
                } else {
                    const err = await res.json(); Toast.error(err.detail);
                }
            } catch (er) { Toast.error(er.message); }
            btn.textContent = 'Provision Role'; btn.disabled = false;
        };

        // Edit
        window.openEdit = (role, isSuper, canLogin) => {
            document.getElementById('edit-role-name-display').textContent = role;
            document.getElementById('edit-role-name').value = role;
            document.getElementById('edit-superuser').checked = isSuper;
            document.getElementById('edit-login').checked = canLogin;
            document.getElementById('edit-role-pass').value = ''; // Reset pass
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        document.getElementById('edit-form').onsubmit = async (e) => {
            e.preventDefault();
            const role = document.getElementById('edit-role-name').value;
            const data = Object.fromEntries(new FormData(e.target));

            // Prepare payload - only include password if set
            const payload = {
                superuser: !!data.superuser,
                login: !!data.login
            };
            if (data.password) payload.password = data.password;

            try {
                const res = await fetch(`/api/v1/cluster/${clusterName}/auth/roles/${role}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    Toast.success('Role Updated');
                    document.getElementById('edit-modal').classList.add('hidden');
                    fetchRoles();
                } else {
                    const err = await res.json(); Toast.error(err.detail);
                }
            } catch (er) { Toast.error(er.message); }
        };

        // Permissions
        window.openPerms = (role) => {
            currentPermRole = role;
            document.getElementById('perm-role-name-display').textContent = role;
            document.getElementById('perm-modal').classList.remove('hidden');

            // Reset to visualizer tab
            const firstTab = document.querySelectorAll('[data-perm-tab]')[0];
            if (firstTab) firstTab.click();

            loadPerms(role);
        };

        document.getElementById('grant-btn').onclick = () => {
            const res = document.getElementById('perm-resource').value;
            const type = document.getElementById('perm-type').value;
            if (!res) return Toast.error('Resource descriptor required');

            callPerm('grant', { role: currentPermRole, resource: res, permission: type })
                .then(ok => { if (ok) { document.getElementById('perm-resource').value = ''; loadPerms(currentPermRole); } });
        };
    }

    function loadPerms(role) {
        const list = document.getElementById('perm-list');
        const ksArea = document.getElementById('vis-nodes-ks');
        const tbArea = document.getElementById('vis-nodes-tb');
        const authArea = document.getElementById('vis-nodes-auth');

        list.innerHTML = '<div style="padding:20px; text-align:center;">Loading permissions...</div>';
        ksArea.innerHTML = ''; tbArea.innerHTML = ''; authArea.innerHTML = '';

        fetch(`/api/v1/cluster/${clusterName}/auth/permissions/${encodeURIComponent(role)}`)
            .then(res => res.json())
            .then(perms => {
                if (perms.detail) return list.innerHTML = `<div style="padding:10px; color:#ff5252;">${perms.detail}</div>`;

                if (!perms.length) {
                    list.innerHTML = '<div style="padding:20px; width:100%; text-align:center; color:#888;">No explicit permissions found.</div>';
                    const msg = '<div class="vis-empty">NONE</div>';
                    ksArea.innerHTML = msg; tbArea.innerHTML = msg; authArea.innerHTML = msg;
                    return;
                }

                list.innerHTML = '';
                perms.sort((a, b) => a.resource.localeCompare(b.resource));

                perms.forEach(p => {
                    // Populate List view
                    const div = document.createElement('div');
                    div.className = 'perm-item';
                    const safeRes = p.resource.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const displayRes = safeRes.startsWith("&lt;") ?
                        `<span style="opacity:0.7; font-style:italic;">${safeRes}</span>` : safeRes;

                    div.innerHTML = `
                         <div class="perm-name">${p.permission}</div>
                         <div class="perm-res" title="${safeRes}">${displayRes}</div>
                         <div class="perm-actions">
                            <button class="perm-revoke" onclick='revoke("${p.resource.replace(/'/g, "\\'")}", "${p.permission}")'>REVOKE</button>
                         </div>
                    `;
                    list.appendChild(div);

                    // Populate Visualizer
                    const node = document.createElement('div');
                    node.className = 'vis-node';
                    node.innerHTML = `<span class="p-type">${p.permission}</span><span class="p-res">${safeRes}</span>`;

                    const resLower = p.resource.toLowerCase();
                    if (resLower.includes('keyspace') && !resLower.includes('.')) {
                        ksArea.appendChild(node);
                    } else if (resLower.includes('.') || resLower.includes('table')) {
                        tbArea.appendChild(node);
                    } else {
                        authArea.appendChild(node);
                    }
                });

                // Add "Safe" status if empty
                if (!ksArea.innerHTML) ksArea.innerHTML = '<div class="vis-empty">NONE</div>';
                if (!tbArea.innerHTML) tbArea.innerHTML = '<div class="vis-empty">NONE</div>';
                if (!authArea.innerHTML) authArea.innerHTML = '<div class="vis-empty">NONE</div>';
            })
            .catch(e => {
                list.innerHTML = '<div style="padding:10px; color:#ff5252;">Failed to load permissions.</div>';
                Toast.error(e.message);
            });
    }

    window.revoke = (res, perm) => {
        ConfirmModal.show({
            title: 'Revoke Permission',
            body: `Are you sure you want to revoke <strong>${perm}</strong> on <strong>${res}</strong>?`,
            confirmText: 'Revoke',
            confirmClass: 'btn-danger',
            onConfirm: () => {
                callPerm('revoke', { role: currentPermRole, resource: res, permission: perm })
                    .then(ok => { if (ok) loadPerms(currentPermRole); });
            }
        });
    };

    async function callPerm(action, body) {
        const res = await fetch(`/api/v1/cluster/${clusterName}/auth/permissions/${action}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
        });
        if (res.ok) { Toast.success(action.toUpperCase() + ' Success'); return true; }
        const e = await res.json(); Toast.error(e.detail); return false;
    }
</script>
{% endblock %}