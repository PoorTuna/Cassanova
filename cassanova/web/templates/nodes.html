{% extends "base.html" %}

{% block title %}Nodes â€” {{ cluster_name }}{% endblock %}

{% block head_extra %}
<script type="module" src="/static/scripts/app/nodes.js" defer></script>
{% endblock %}

{% block content %}
<main class="with-sidebar">
    <section class="nodes-overview">
        <h2>Cluster Nodes</h2>
        <div class="header-actions">
            <input type="search" id="node-filter" placeholder="Filter nodes..." autocomplete="off" />
            <button class="refresh-btn" onclick="location.reload()">Refresh</button>
        </div>
    </section>

    <div class="nodes-container">
        <!-- Sidebar List -->
        <div id="node-list">
            {% if nodes %}
            {% for node in nodes %}
            <div class="node-item {% if loop.first %}active{% endif %}" data-address="{{ node.broadcast_address }}"
                onclick="selectNode(this, '{{ node.broadcast_address }}')">
                <strong>{{ node.broadcast_address }}</strong>
                <div class="node-meta">{{ node.data_center }}</div>
            </div>
            {% endfor %}
            {% else %}
            <p class="no-nodes">No nodes found.</p>
            {% endif %}
        </div>

        <!-- Detail Panel -->
        <div id="node-detail">
            {% if nodes %}
            {% for node in nodes %}
            <div class="node-detail-view {% if not loop.first %}hidden{% endif %}"
                id="detail-{{ node.broadcast_address }}">

                <!-- Header -->
                <header class="detail-header">
                    <div class="title-group">
                        <h3>{{ node.broadcast_address or node.rpc_address }}</h3>
                        {% if node.key == 'local' %}<span class="badge"
                            style="background: rgba(0, 229, 255, 0.15); color: var(--color-primary);">Local
                            Node</span>{% endif %}
                    </div>
                </header>

                <!-- Core Stats -->
                <div class="detail-grid">
                    <div class="detail-card">
                        <span class="label">Host ID</span>
                        <span class="value code copyable" title="Click to copy">{{ node.host_id }}</span>
                    </div>
                    <div class="detail-card">
                        <span class="label">Data Center</span>
                        <span class="value">{{ node.data_center }}</span>
                    </div>
                    <div class="detail-card">
                        <span class="label">Rack</span>
                        <span class="value">{{ node.rack }}</span>
                    </div>
                    <div class="detail-card">
                        <span class="label">Cassandra Version</span>
                        <span class="value">{{ node.release_version }}</span>
                    </div>
                    {% if node.cluster_name %}
                    <div class="detail-card">
                        <span class="label">Cluster Name</span>
                        <span class="value">{{ node.cluster_name }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Network & Protocol -->
                <div class="detail-section">
                    <h4>Networking & Protocol</h4>
                    <div class="options-grid">
                        <div class="option-item">
                            <span class="opt-key">Broadcast Address</span>
                            <span class="opt-val">{{ node.broadcast_address or 'N/A' }}{% if node.broadcast_port %}:{{
                                node.broadcast_port }}{% endif %}</span>
                        </div>
                        <div class="option-item">
                            <span class="opt-key">Native Transport</span>
                            <span class="opt-val">{{ node.rpc_address or 'N/A' }}{% if node.rpc_port %}:{{ node.rpc_port
                                }}{% endif %}</span>
                        </div>
                        {% if node.listen_address %}
                        <div class="option-item">
                            <span class="opt-key">Listen Address</span>
                            <span class="opt-val">{{ node.listen_address }}{% if node.listen_port %}:{{ node.listen_port
                                }}{% endif %}</span>
                        </div>
                        {% endif %}
                        {% if node.native_protocol_version %}
                        <div class="option-item">
                            <span class="opt-key">Protocol Version</span>
                            <span class="opt-val">{{ node.native_protocol_version }}</span>
                        </div>
                        {% endif %}
                        {% if node.cql_version %}
                        <div class="option-item">
                            <span class="opt-key">CQL Version</span>
                            <span class="opt-val">{{ node.cql_version }}</span>
                        </div>
                        {% endif %}
                        {% if node.partitioner %}
                        <div class="option-item">
                            <span class="opt-key">Partitioner</span>
                            <span class="opt-val">{{ node.partitioner.split('.')[-1] }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                    <!-- Tokens -->
                <div class="detail-section">
                    <h4>Tokens ({{ node.tokens | length }})</h4>
                    <div class="token-box code">
                        {{ node.tokens | join(', ') }}
                    </div>
                </div>

                <!-- Schema Info -->
                <div class="detail-section">
                    <h4>Schema Version</h4>
                    <div class="schema-box code copyable" title="Click to copy">
                        {{ node.schema_version }}
                    </div>
                </div>

                {% if node.bootstrapped %}
                <!-- Bootstrap Status (Local Node Only) -->
                <div class="detail-section">
                    <h4>Bootstrap Status</h4>
                    <div class="option-item">
                        <span class="opt-key">Status</span>
                        <span class="opt-val">{{ node.bootstrapped }}</span>
                    </div>
                </div>
                {% endif %}

            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">
                <p>No nodes available.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        function selectNode(el, address) {
            // Update active state in list
            document.querySelectorAll('.node-item').forEach(item => item.classList.remove('active'));
            el.classList.add('active');

            // Show detail view
            document.querySelectorAll('.node-detail-view').forEach(view => view.classList.add('hidden'));
            const target = document.getElementById('detail-' + address);
            if (target) target.classList.remove('hidden');
        }

        // Filter Logic
        document.getElementById('node-filter').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.node-item').forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = text.includes(term) ? 'flex' : 'none';
            });
        });
    </script>
</main>
{% endblock %}