{% extends "base.html" %}

{% block title %}Cassanova | Unified Cassandra Management{% endblock %}

{% block head_extra %}
<link href="/static/styles/app/sstable-smasher.css" rel="stylesheet" />
<script src="/static/scripts/app/index.js" defer></script>
<script src="/static/scripts/app/sstable-smasher.js" defer></script>
{% endblock %}

{% block content %}
<main class="home-container">
    <canvas id="bg-particles"></canvas>

    <header class="hero-header">
        <div class="brand-group">
            <img src="/static/icons/logo/cassanova-logo.png" class="hero-logo" alt="Cassanova Logo">
            <h1>Cassanova</h1>
        </div>
        <p class="hero-subtitle">Unified Operations Hub for Apache Cassandra</p>

        <div class="search-wrapper">
            <input type="text" id="cluster-filter" placeholder="Locate your cluster..." aria-label="Filter clusters" />
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </div>
    </header>

    <div id="cluster-grid">
        {% for name, config in clusters.items() %}
        <div class="cluster-hero-card cluster-row" data-name="{{ name | lower }}"
            onclick="window.location.href='/cluster/{{ name }}'">

            <div class="card-main">
                <div class="cluster-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                </div>
                <h3>{{ name }}</h3>
                <div class="cluster-meta">
                    <div class="meta-item">
                        <span class="meta-label">Contact Pts</span>
                        <span class="meta-val">{{ config.contact_points | length }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Port</span>
                        <span class="meta-val">{{ config.port }}</span>
                    </div>
                </div>
            </div>

            <div class="card-footer">
                <span class="contact-points">{{ config.contact_points[0] }}{% if config.contact_points | length > 1 %},
                    ...{% endif %}</span>
                <div class="arrow-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 6 15 12 9 18" />
                    </svg>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- SSTable Smasher Trigger -->
    <div id="game-trigger" title="Compaction Simulator" onclick="openSSTableSmasher()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21"></line>
            <line x1="15" y1="3" x2="15" y2="21"></line>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="3" y1="15" x2="21" y2="15"></line>
        </svg>
    </div>

    <!-- SSTable Smasher Game Modal -->
    <div id="game-modal" class="hidden">
        <div class="close-game" onclick="closeSSTableSmasher()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </div>
        <div class="game-container">
            <div class="game-stats">
                <div class="stat-item">COMPACTION SCORE: <span id="game-score-val">0</span></div>
                <div class="stat-item">READ LATENCY (P99): <span id="latency-val"
                        style="color: var(--color-success)">0ms</span></div>
                <div class="stat-item">DISK STATUS: <span style="color: var(--color-success)">NOMINAL</span></div>
            </div>

            <!-- Help Trigger -->
            <div class="game-help-trigger" onclick="toggleGameManual()" title="Operations Manual">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>

            <div id="game-start-overlay" class="game-overlay">
                <div class="game-title">SSTABLE SMASHER</div>
                <div class="game-subtitle">STCS - TOKEN RING SIMULATOR</div>
                <div class="game-instructions">
                    MANAGE THE 12 TOKEN BUCKETS<br>
                    <span class="accent">ARROWS</span> TO SELECT TOKEN SECTOR<br>
                    <span class="accent">SPACE</span> TO FLUSH SSTABLE<br><br>
                    <span style="font-size: 0.75rem; letter-spacing: 0.1em; opacity: 0.6">SIZE-TIERED COMPACTION
                        (STCS)</span><br>
                    <span style="font-size: 0.75rem; letter-spacing: 0.1em; color: #ef4444">WATCH OUT FOR TOMBSTONES
                        (T)</span><br><br>
                    PRESS SPACE TO SCAN RING
                </div>
            </div>

            <!-- Manual Overlay -->
            <div id="game-manual-overlay" class="game-overlay hidden">
                <div class="manual-content glass-panel">
                    <h3>OPERATIONS MANUAL</h3>
                    <div class="manual-section">
                        <h4>Size-Tiered Compaction (STCS)</h4>
                        <p>Stack 4 identical size tables (L0, L1, etc.) in one bucket to trigger a merge. This reduces
                            the number of SSTables and improves read performance.</p>
                    </div>
                    <div class="manual-section">
                        <h4>The Token Ring</h4>
                        <p>Your cluster is divided into 12 sectors. Distribute your writes (Space) evenly to prevent
                            single-node disk overflows.</p>
                    </div>
                    <div class="manual-section">
                        <h4>GC Grace Period</h4>
                        <p>Tombstones (T) are generated on delete. They stay for 10 turns. You cannot building on top of
                            them until they expire and the node reclaims space.</p>
                    </div>
                    <button class="btn-primary" onclick="toggleGameManual()">RESUME OPS</button>
                </div>
            </div>

            <canvas id="game-canvas"></canvas>
        </div>
    </div>


    <script>
        function openSSTableSmasher() {
            document.getElementById('game-modal').classList.remove('hidden');
            if (!window.gameInstance) {
                window.initGame();
                window.gameInstance.draw(); // Initial draw
            }
        }
        function closeSSTableSmasher() {
            document.getElementById('game-modal').classList.add('hidden');
            if (window.gameInstance) {
                window.gameInstance.isPaused = true;
            }
        }
        function toggleGameManual() {
            const man = document.getElementById('game-manual-overlay');
            const startOverlay = document.getElementById('game-start-overlay');
            const helpTrigger = document.querySelector('.game-help-trigger');
            const isClosing = !man.classList.contains('hidden');

            man.classList.toggle('hidden');
            if (helpTrigger) helpTrigger.classList.toggle('hidden');

            if (window.gameInstance) {
                // Only "resume" if the game has actually been started (start overlay is gone)
                const gameAlreadyStarted = startOverlay.classList.contains('hidden');

                if (gameAlreadyStarted) {
                    window.gameInstance.isPaused = !isClosing;
                    if (isClosing) window.gameInstance.loop();
                }
            }
        }
    </script>
</main>
{% endblock %}