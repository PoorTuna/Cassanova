{% extends "base.html" %}

{% block title %}Explorer: {{ table_name }} - Cassanova{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="/static/styles/app/explorer.css">
<script src="/static/scripts/app/explorer.js" defer></script>
{% endblock %}

{% block content %}
<main class="main-content explorer-page with-sidebar" data-cluster="{{ cluster_config_entry }}"
    data-keyspace="{{ keyspace_name }}" data-table="{{ table_name }}"
    data-pk="{{ primary_key | tojson | forceescape }}">

    <header class="explorer-header">
        <div class="breadcrumb">
            <a href="/cluster/{{ cluster_config_entry }}/keyspace/{{ keyspace_name }}">{{ keyspace_name }}</a>
            <span class="separator">/</span>
            <span class="active">{{ table_name }}</span>
        </div>
        <h1>Data Explorer</h1>
        <div id="expensive-query-warning" class="warning-alert hidden">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <span>Expensive Query: Filtering without index enabled (ALLOW FILTERING)</span>
        </div>
        <div class="actions-bar">
            <div class="filter-builder">
                <button id="add-filter-btn" class="btn-outline">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"></path>
                    </svg>
                    Add Filter
                </button>
                <div id="filter-popover" class="glass-panel popover hidden">
                    <div class="popover-arrow"></div>
                    <div class="popover-header">Add Filter</div>
                    <div class="popover-body">
                        <div class="filter-field-group">
                            <label for="filter-column-select">Field</label>
                            <select id="filter-column-select">
                                <option value="">Select Field...</option>
                            </select>
                        </div>
                        <div class="filter-field-group">
                            <label for="filter-operator-select">Operator</label>
                            <select id="filter-operator-select">
                                <option value="=">=</option>
                                <option value=">">&gt;</option>
                                <option value="<">&lt;</option>
                                <option value=">=">&gt;=</option>
                                <option value="<=">&lt;=</option>
                                <option value="IN">IN</option>
                                <option value="CONTAINS">CONTAINS</option>
                                <option value="CONTAINS KEY">CONTAINS KEY</option>
                                <option value="LIKE">LIKE</option>
                            </select>
                        </div>
                        <div class="filter-field-group wide">
                            <label for="filter-value-input">Value</label>
                            <input type="text" id="filter-value-input" placeholder="Value (use comma for IN)...">
                        </div>
                        <div class="filter-field-group wide">
                            <label class="toggle-container">
                                <input type="checkbox" id="allow-filtering-toggle">
                                <span class="toggle-label">Enable ALLOW FILTERING</span>
                            </label>
                        </div>
                    </div>
                    <div class="popover-footer">
                        <button id="cancel-filter" class="btn-text">Cancel</button>
                        <button id="submit-filter" class="btn-primary-sm">Add Filter</button>
                    </div>
                </div>
                <div id="filter-chips" class="filter-chips">
                    <!-- Dynamic chips -->
                </div>
            </div>
            <div class="view-controls">
                <button id="export-csv-btn" class="btn-outline" title="Export to CSV">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"></path>
                    </svg>
                    Export CSV
                </button>
                <button id="import-csv-btn" class="btn-outline" title="Import from CSV">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"></path>
                    </svg>
                    Import CSV
                </button>
                <button id="insert-row-btn" class="btn-primary-sm" title="Insert New Row">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"></path>
                    </svg>
                    Insert Row
                </button>
                <button id="refresh-data" class="btn-icon-only" title="Refresh">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <div class="explorer-container glass-panel">
        <div class="table-scroll-wrapper">
            <table id="data-table">
                <thead>
                    <tr id="table-head-row">
                        <!-- Dynamic headers -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Dynamic rows -->
                </tbody>
            </table>
            <div id="loading-overlay" class="hidden">
                <div class="loader"></div>
                <p>Fetching data from {{ table_name }}...</p>
            </div>
            <div id="empty-state" class="hidden">
                <p>No rows found in this table.</p>
            </div>
        </div>

        <footer class="explorer-footer">
            <div class="pagination">
                <button id="prev-page" disabled>Previous</button>
                <span id="page-info">Showing top 100 rows</span>
                <button id="next-page">Next</button>
            </div>
            <div class="stats">
                <span id="row-count">0 rows</span>
            </div>
        </footer>

        <!-- Deletion Confirmation Modal -->
        <div id="delete-confirm-modal" class="modal hidden">
            <div class="modal-content glass-panel">
                <div class="modal-header">
                    <h3>Confirm Deletion</h3>
                    <button class="btn-close-x close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this row?</p>
                    <div id="delete-row-details" class="details-box"></div>
                    <p class="warning-text"><small>This action cannot be undone.</small></p>
                </div>
                <div class="modal-footer">
                    <button class="btn-text close-modal">Cancel</button>
                    <button id="confirm-delete-btn" class="btn-danger">Delete Row</button>
                </div>
            </div>
        </div>

        <!-- Insert Row Modal -->
        <div id="insert-row-modal" class="modal hidden">
            <div class="modal-content glass-panel large-modal">
                <div class="modal-header">
                    <h3>Insert New Row</h3>
                    <button class="btn-close-x close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="insert-row-form" class="dynamic-form">
                        <!-- Form fields will be generated dynamically -->
                        <div id="insert-form-fields" class="form-grid"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-text close-modal">Cancel</button>
                    <button id="submit-insert-btn" class="btn-primary-sm">Insert Row</button>
                </div>
            </div>
        </div>

        <div id="context-menu" class="context-menu hidden">
            <ul>
                <li id="menu-metadata">
                    <div class="menu-item-content">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span>View Metadata (TTL/WriteTime)</span>
                    </div>
                    <div id="metadata-details" class="metadata-details hidden">
                        <p>TTL: <span id="meta-ttl">N/A</span></p>
                        <p>WriteTime: <span id="meta-writetime">N/A</span></p>
                    </div>
                </li>
                <li id="menu-copy-cql">
                    <div class="menu-item-content">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                        <span>Copy as UPDATE</span>
                    </div>
                </li>
                <li id="menu-delete-row" class="menu-item-danger">
                    <div class="menu-item-content">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2">
                            </path>
                        </svg>
                        <span>Delete Row</span>
                    </div>
                </li>
            </ul>
        </div>
        <!-- Import CSV Modal -->
        <div id="import-csv-modal" class="modal hidden">
            <div class="modal-content glass-panel">
                <div class="modal-header">
                    <h3>Import Data from CSV</h3>
                    <span class="modal-close close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Select a CSV file to import into <strong>{{ table_name }}</strong>. Ensure headers match column
                        names exactly.</p>
                    <div class="import-drop-zone" id="import-drop-zone">
                        <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                        <div class="drop-zone-content">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"></path>
                            </svg>
                            <p>Click to select or drag & drop CSV file</p>
                        </div>
                    </div>
                    <div id="import-status" class="hidden" style="margin-top: 20px;">
                        <div class="progress-container"
                            style="height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden; margin-bottom: 10px;">
                            <div id="import-progress-bar" class="progress-bar"
                                style="height: 100%; width: 0%; background: var(--color-primary); transition: width 0.3s;">
                            </div>
                        </div>
                        <p id="import-status-text" style="font-size: 0.9rem; color: var(--text-secondary);">Uploading...
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary close-modal">Cancel</button>
                    <button id="confirm-import-btn" class="btn-primary" disabled>Start Import</button>
                </div>
            </div>
        </div>
</main>
{% endblock %}