{% extends "base.html" %}

{% block title %}Schema Designer: {{ keyspace_name }} - Cassanova{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="/static/styles/app/table-builder.css">
<script src="/static/scripts/app/table-builder.js" defer></script>
{% endblock %}

{% block content %}
<main class="with-sidebar builder-page" data-cluster="{{ cluster_config_entry }}" data-keyspace="{{ keyspace_name }}">
    <header class="builder-header">
        <div class="breadcrumb">
            <a href="/cluster/{{ cluster_config_entry }}">{{ cluster_name }}</a>
            <span class="separator">/</span>
            <a href="/cluster/{{ cluster_config_entry }}/keyspace/{{ keyspace_name }}">{{ keyspace_name }}</a>
            <span class="separator">/</span>
            <span class="active">Table Designer</span>
        </div>
        <h1>New Table Designer</h1>
        <div class="header-actions">
            <button id="create-table-btn" class="btn-primary" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"></path>
                </svg>
                Execute DDL
            </button>
        </div>
    </header>

    <div class="builder-layout">
        <!-- Main Form Area -->
        <div class="builder-form">
            <!-- Table Settings -->
            <section class="form-section">
                <h3>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                    Basic Identity
                </h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Table Name</label>
                        <input type="text" id="table-name" placeholder="e.g. user_events" autocomplete="off" required>
                    </div>
                </div>
            </section>

            <!-- Columns Section -->
            <section class="form-section">
                <h3>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5">
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                        <path d="M3 5c0 1.66 4 3 9 3s9-1.34 9-3"></path>
                        <path d="M21 5v14c0 1.66-4 3-9 3s-9-1.34-9-3V5"></path>
                    </svg>
                    Column Definitions
                </h3>
                <div id="columns-list" class="columns-list">
                    <!-- Column rows injected by JS -->
                </div>
                <button id="add-column-btn" class="btn-outline add-col-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"></path>
                    </svg>
                    Add Column
                </button>
            </section>

            <!-- Table Options -->
            <section class="form-section">
                <h3>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M12 15V3m0 12l-4-4m4 4l4-4M2 17l.621 2.485A2 2 0 004.561 21h14.878a2 2 0 001.94-1.515L22 17">
                        </path>
                    </svg>
                    Storage Strategy
                </h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Compaction Strategy</label>
                        <select id="compaction-strategy">
                            <option value="SizeTieredCompactionStrategy">SizeTieredCompactionStrategy (STCS)</option>
                            <option value="LeveledCompactionStrategy">LeveledCompactionStrategy (LCS)</option>
                            <option value="TimeWindowCompactionStrategy">TimeWindowCompactionStrategy (TWCS)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Default TTL (seconds)</label>
                        <input type="number" id="default-ttl" placeholder="0 (No TTL)" min="0">
                    </div>
                </div>
            </section>
        </div>

        <!-- Sidebar Preview Area -->
        <div class="preview-panel">
            <div class="safety-analyzer">
                <div class="safety-header">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    Safety Analysis
                </div>
                <div id="safety-report" class="safety-message">
                    Provide a table name and at least one primary key to begin analysis.
                </div>
            </div>

            <div class="cql-preview-box">
                <div class="preview-label">Live CQL Preview</div>
                <pre id="cql-preview">-- Automated DDL will appear here</pre>
            </div>
        </div>
    </div>
</main>

<!-- Execute Confirmation Modal -->
<div id="execute-modal" class="modal hidden">
    <div class="modal-content glass-panel">
        <div class="modal-header">
            <h3>Execute Schema Change</h3>
            <button class="btn-close-x close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>You are about to create a new table in <strong>{{ keyspace_name }}</strong>.</p>
            <div class="details-box">
                <pre id="final-cql-confirm" style="font-size: 0.8rem; white-space: pre-wrap;"></pre>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-text close-modal">Cancel</button>
            <button id="confirm-execute-btn" class="btn-primary">Confirm & Create</button>
        </div>
    </div>
</div>
{% endblock %}